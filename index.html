<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅游大巴座位抽签系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
            --bus-color: #e74c3c;
            --driver-seat: #2c3e50;
            --available-seat: #ecf0f1;
            --reserved-seat: #95a5a6;
            --occupied-seat: #2ecc71;
            --single-seat: #9b59b6;
            --single-occupied: #f39c12;
            --aisle: #7f8c8d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #f0f7ff 0%, #e1f0ff 100%);
            color: #333;
            padding: 15px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            animation: fadeInDown 0.6s ease;
        }
        
        h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            max-width: 700px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr 1.2fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease;
            animation-fill-mode: both;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }
        
        input, textarea, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        input:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            font-size: 0.95rem;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn-group button {
            flex: 1;
            min-width: 140px;
        }
        
        .btn-draw {
            background: var(--secondary);
        }
        
        .btn-draw:hover {
            background: #27ae60;
        }
        
        .btn-reset {
            background: var(--warning);
        }
        
        .btn-reset:hover {
            background: #e67e22;
        }
        
        .seat-layout {
            margin-top: 20px;
        }
        
        .bus-container {
            perspective: 800px;
        }
        
        .bus {
            position: relative;
            background: var(--bus-color);
            border-radius: 15px 60px 8px 8px;
            padding: 20px 15px 12px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transform-style: preserve-3d;
            animation: busEntrance 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .bus::before {
            content: "";
            position: absolute;
            top: 15px;
            left: 0;
            width: 35px;
            height: 60px;
            background: #3498db;
            border-radius: 0 7px 7px 0;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        }
        
        .bus::after {
            content: "";
            position: absolute;
            bottom: 12px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2c3e50;
            border: 5px solid #7f8c8d;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.25);
        }
        
        .driver-seat {
            background: var(--driver-seat);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 7px;
            margin-bottom: 20px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            max-width: 180px;
            margin-left: 8px;
            animation: fadeIn 0.6s ease;
            font-size: 0.95rem;
        }
        
        .seat-rows {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .seat-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            position: relative;
        }
        
        .row-number {
            position: absolute;
            left: -22px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            background: #ffd700;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            z-index: 2;
        }
        
        .left-seats, .right-seats {
            display: flex;
            gap: 12px;
        }
        
        .aisle {
            width: 35px;
            background: #d1d8da;
            border-radius: 4px;
            margin: 0 8px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.08);
        }
        
        .seat {
            width: 75px;
            background: var(--available-seat);
            border: 1px solid #bdc3c7;
            border-radius: 7px;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.06);
            animation: seatAppear 0.5s ease-out;
            animation-fill-mode: both;
        }
        
        .seat:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            z-index: 2;
        }
        
        .seat-number {
            position: absolute;
            top: 6px;
            left: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #7f8c8d;
            background: rgba(255, 255, 255, 0.7);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .passenger-name {
            font-weight: 600;
            margin: 4px 0;
            font-size: 14px;
            word-break: break-all;
        }
        
        .seat.reserved {
            background: var(--reserved-seat);
            color: white;
        }
        
        .seat.occupied {
            background: var(--occupied-seat);
            color: white;
        }
        
        .seat.single {
            background: var(--single-seat);
            color: white;
        }
        
        .seat.single-occupied {
            background: var(--single-occupied);
            color: white;
        }
        
        .results {
            margin-top: 25px;
        }
        
        .passenger-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .passenger-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            text-align: center;
            transition: all 0.25s ease;
            animation: fadeInUp 0.4s ease;
        }
        
        .passenger-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .passenger-item.group {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        }
        
        .passenger-item.single {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }
        
        .passenger-item.single-occupied {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }
        
        .group-header {
            font-weight: 700;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }
        
        .legend-driver { background: var(--driver-seat); }
        .legend-available { background: var(--available-seat); }
        .legend-reserved { background: var(--reserved-seat); }
        .legend-occupied { background: var(--occupied-seat); }
        .legend-single { background: var(--single-seat); }
        .legend-single-occupied { background: var(--single-occupied); }
        
        .instructions {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            animation: fadeInUp 0.6s ease;
        }
        
        .instructions h3 {
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
        }
        
        .instructions ul {
            padding-left: 20px;
            font-size: 0.95rem;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #e0e0e0;
        }
        
        .empty-row {
            text-align: center;
            padding: 25px;
            color: #7f8c8d;
            font-style: italic;
            animation: fadeIn 0.8s ease;
            font-size: 0.95rem;
        }
        
        .system-info {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            font-size: 0.9rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .info-item {
            text-align: center;
            flex: 1;
            min-width: 130px;
        }
        
        .info-value {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            margin-top: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-ready {
            background-color: var(--secondary);
        }
        
        .status-waiting {
            background-color: var(--warning);
        }
        
        .progress-container {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(52, 152, 219, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .rule-highlight {
            background: #fff9c4;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .bus-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .bus-type-option {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .bus-type-option.active {
            border-color: var(--primary);
            background: rgba(52, 152, 219, 0.1);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .bus-type-option i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .bus-type-option h3 {
            margin-bottom: 4px;
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        .bus-type-option p {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes busEntrance {
            from {
                opacity: 0;
                transform: translateY(80px) rotateX(30deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) rotateX(0);
            }
        }
        
        @keyframes seatAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mobile-only {
            display: block;
        }
        
        .desktop-only {
            display: none;
        }
        
        @media (min-width: 768px) {
            .mobile-only {
                display: none;
            }
            
            .desktop-only {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-bus"></i> 旅游大巴座位抽签系统</h1>
            <p class="subtitle">公平、随机的座位分配解决方案，支持多种大巴车型</p>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <h2><i class="fas fa-cog"></i> 系统设置</h2>
                
                <!-- 车型选择器 -->
                <div class="form-group">
                    <label><i class="fas fa-bus-alt"></i> 选择大巴车型</label>
                    <div class="bus-type-selector">
                        <div class="bus-type-option active" data-type="2+2">
                            <i class="fas fa-bus"></i>
                            <h3>2+2普通大巴</h3>
                            <p class="mobile-only">每排4座</p>
                        </div>
                        <div class="bus-type-option" data-type="2+1">
                            <i class="fas fa-bus"></i>
                            <h3>2+1豪华大巴</h3>
                            <p class="mobile-only">每排3座</p>
                        </div>
                    </div>
                    <input type="hidden" id="busType" value="2+2">
                </div>
                
                <div class="form-group">
                    <label for="totalSeats"><i class="fas fa-chair"></i> 大巴总座位数（含司机）</label>
                    <input type="number" id="totalSeats" min="5" max="60" value="22">
                </div>
                
                <div class="form-group">
                    <label for="reservedSeats"><i class="fas fa-lock"></i> 预留座位号（空格分隔）</label>
                    <input type="text" id="reservedSeats" placeholder="如：3 5 7" value="1 2 3 4">
                </div>
                
                <div class="form-group">
                    <label for="passengerData"><i class="fas fa-users"></i> 乘客信息（一行一组）</label>
                    <textarea id="passengerData" placeholder="例如：
张三+李四
王五
赵六+钱七">张三+李四
王五
赵六+钱七
孙八
周九+吴十
郑十一
钱十二+孙十三
林十四
杨十五
陈十六</textarea>
                </div>
                
                <div class="system-info">
                    <div class="info-item">
                        <div>系统状态</div>
                        <div><span class="status-indicator status-ready"></span> <span id="systemStatus">准备就绪</span></div>
                    </div>
                    <div class="info-item">
                        <div>座位使用率</div>
                        <div class="info-value" id="seatUsage">0%</div>
                        <div class="progress-container">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn-draw" id="drawBtn"><i class="fas fa-random"></i> 开始抽签分配</button>
                    <button class="btn-reset" id="resetBtn"><i class="fas fa-redo"></i> 重置系统</button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-map-marked-alt"></i> 座位布局预览</h2>
                <div class="seat-layout" id="seatLayout">
                    <div class="bus-container">
                        <div class="bus">
                            <div class="loading-overlay" id="loadingOverlay">
                                <div class="spinner"></div>
                                <div class="loading-text">正在分配座位...</div>
                            </div>
                            <div class="driver-seat">
                                <i class="fas fa-user-shield"></i> 司机
                            </div>
                            <div class="empty-row">请设置参数并点击"开始抽签分配"按钮生成座位布局</div>
                        </div>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color legend-driver"></div>
                        <span>司机座位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-available"></div>
                        <span>可用座位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-reserved"></div>
                        <span>预留座位</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-occupied"></div>
                        <span>已分配（双人）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-single"></div>
                        <span>已分配（单人）</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-single-occupied"></div>
                        <span>单人占单座</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card results">
            <h2><i class="fas fa-list-alt"></i> 分配结果</h2>
            <div id="passengerResults">
                <div class="empty-row">座位分配结果将显示在这里</div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
            <ul>
                <li><strong>大巴车型选择</strong>：支持2+2普通大巴和2+1豪华大巴两种车型</li>
                <li><strong>大巴座位布局</strong>：第一行为司机，乘客座位号从1开始</li>
                <li><strong>行号显示</strong>：每行座位左侧显示用中文大写数字表示行数</li>
                <li><strong>预留座位</strong>：输入座位号（如"1 2 3"），这些座位将不会分配给乘客</li>
                <li><strong>乘客信息</strong>：每行一组，双人组用"+"连接（如：张三+李四），单人单独一行</li>
                <li><span class="rule-highlight">单人乘客分配规则</span>：
                    <ul style="padding-left: 20px; margin-top: 8px;">
                        <li>优先分配到只有一个空位的位置（相邻座位已被预留）</li>
                        <li>如果没有此类位置，则分配同一侧的两个座位</li>
                    </ul>
                </li>
                <li><strong>分配原则</strong>：从前排开始分配，空座位留在后排</li>
            </ul>
        </div>
        
        <footer>
            <p>© 2025 旅游大巴座位抽签系统 | 支持多种车型的公平座位分配解决方案 | 一路旅游管家仔</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const drawBtn = document.getElementById('drawBtn');
            const resetBtn = document.getElementById('resetBtn');
            const seatLayout = document.getElementById('seatLayout');
            const passengerResults = document.getElementById('passengerResults');
            const systemStatus = document.getElementById('systemStatus');
            const seatUsage = document.getElementById('seatUsage');
            const progressBar = document.getElementById('progressBar');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const busTypeInput = document.getElementById('busType');
            const busTypeOptions = document.querySelectorAll('.bus-type-option');
            
            // 中文大写数字映射
            const chineseNumbers = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖', '拾'];
            
            // 设置车型选择事件
            busTypeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    busTypeOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    busTypeInput.value = this.dataset.type;
                });
            });
            
            // 按钮事件监听
            drawBtn.addEventListener('click', drawSeats);
            resetBtn.addEventListener('click', resetSystem);
            
            // 主功能：座位抽签
            function drawSeats() {
                // 显示加载动画
                loadingOverlay.classList.add('active');
                updateSystemStatus("正在分配座位...", false);
                
                // 获取输入值
                const totalSeats = parseInt(document.getElementById('totalSeats').value) || 22;
                const reservedInput = document.getElementById('reservedSeats').value;
                const passengerData = document.getElementById('passengerData').value;
                const busType = busTypeInput.value;
                
                // 解析预留座位
                const reservedSeats = reservedInput.split(/\s+/)
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n) && n > 0);
                
                // 添加司机座到预留
                reservedSeats.push(0);
                
                // 解析乘客数据
                const passengers = parsePassengerData(passengerData);
                
                // 验证数据
                if (passengers.groups.length === 0) {
                    alert('请输入有效的乘客信息！');
                    resetSystemStatus();
                    return;
                }
                
                if (totalSeats < 5) {
                    alert('大巴总座位数至少为5（含司机）！');
                    resetSystemStatus();
                    return;
                }
                
                // 计算需要的乘客座位数
                const passengerSeats = totalSeats - 1;
                const requiredSeats = passengers.groups.reduce((acc, group) => acc + (group.length === 1 ? 1 : 2), 0);
                
                if (requiredSeats > passengerSeats) {
                    alert(`座位不足！需要${requiredSeats}个乘客座位，但只有${passengerSeats}个可用座位。`);
                    resetSystemStatus();
                    return;
                }
                
                // 模拟处理延迟
                setTimeout(() => {
                    // 创建座位布局
                    const seatMap = createSeatMap(totalSeats, reservedSeats, busType);
                    
                    // 随机排序乘客组
                    const shuffledGroups = shuffleArray(passengers.groups);
                    
                    // 分配座位
                    assignSeats(seatMap, shuffledGroups, busType);
                    
                    // 显示结果
                    displaySeatLayout(seatMap, totalSeats, busType);
                    displayPassengerResults(seatMap, shuffledGroups);
                    
                    // 更新系统状态
                    updateSeatUsage(seatMap, passengerSeats);
                    updateSystemStatus("分配完成", true);
                    
                    // 隐藏加载动画
                    loadingOverlay.classList.remove('active');
                }, 1200);
            }
            
            // 解析乘客数据
            function parsePassengerData(data) {
                const lines = data.split('\n').filter(line => line.trim() !== '');
                const groups = [];
                const passengers = [];
                let groupId = 1;
                
                for (const line of lines) {
                    if (line.includes('+')) {
                        // 双人组
                        const [p1, p2] = line.split('+').map(p => p.trim());
                        groups.push([p1, p2]);
                        passengers.push({name: p1, group: groupId, type: 'group'});
                        passengers.push({name: p2, group: groupId, type: 'group'});
                        groupId++;
                    } else {
                        // 单人
                        groups.push([line.trim()]);
                        passengers.push({name: line.trim(), group: groupId, type: 'single'});
                        groupId++;
                    }
                }
                
                return { groups, passengers };
            }
            
            // 创建座位地图
            function createSeatMap(totalSeats, reservedSeats, busType) {
                const seatMap = [];
                const isLuxury = busType === '2+1';
                const seatsPerRow = isLuxury ? 3 : 4;
                const rows = Math.ceil((totalSeats - 1) / seatsPerRow) + 1;
                
                // 添加司机座位（0号）
                seatMap.push({
                    seatNumber: 0,
                    row: 0,
                    col: 0,
                    type: 'driver',
                    reserved: true,
                    occupied: true,
                    passenger: '司机'
                });
                
                // 添加乘客座位（从1号开始）
                let seatNum = 1;
                for (let row = 1; row < rows; row++) {
                    for (let col = 0; col < seatsPerRow; col++) {
                        if (seatNum < totalSeats) {
                            const reserved = reservedSeats.includes(seatNum);
                            const seatType = col < (isLuxury ? 2 : 2) ? 'left' : 'right';
                            
                            seatMap.push({
                                seatNumber: seatNum,
                                row,
                                col,
                                reserved,
                                occupied: reserved,
                                passenger: reserved ? '预留' : null,
                                groupId: null,
                                seatType: seatType
                            });
                            seatNum++;
                        }
                    }
                }
                
                return seatMap;
            }
            
            // 随机排序数组
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // 分配座位
            function assignSeats(seatMap, groups, busType) {
                const isLuxury = busType === '2+1';
                
                // 筛选可用座位（非预留）
                const availableSeats = seatMap.filter(seat => 
                    !seat.reserved && seat.type !== 'driver' && !seat.occupied
                );
                
                // 按行和列排序可用座位（前排优先）
                availableSeats.sort((a, b) => {
                    if (a.row !== b.row) return a.row - b.row;
                    return a.col - b.col;
                });
                
                // 分配座位给组
                for (const group of groups) {
                    if (group.length === 1) {
                        // 尝试为单人乘客寻找只有一个空位的位置
                        const singleSeat = findSingleSeat(availableSeats, seatMap, busType);
                        
                        if (singleSeat) {
                            assignSingleToSeat(group[0], singleSeat);
                            removeSeatFromAvailable(availableSeats, singleSeat);
                            continue;
                        }
                    }
                    
                    // 尝试查找同一排的连续座位
                    let assigned = false;
                    
                    if (!isLuxury || (isLuxury && group.length === 1)) {
                        for (let i = 0; i < availableSeats.length - 1; i++) {
                            const seat1 = availableSeats[i];
                            const seat2 = availableSeats[i + 1];
                            
                            // 检查是否同一排且相邻（同一侧）
                            if (seat1.row === seat2.row && 
                                seat1.seatType === seat2.seatType &&
                                Math.abs(seat1.col - seat2.col) === 1) {
                                
                                assignGroupToSeats(group, seat1, seat2);
                                availableSeats.splice(i, 2);
                                assigned = true;
                                break;
                            }
                        }
                    }
                    
                    // 如果找不到连续座位，分配任意两个可用座位
                    if (!assigned && group.length === 1 && availableSeats.length >= 1) {
                        const seat1 = availableSeats[0];
                        assignSingleToSeat(group[0], seat1);
                        availableSeats.splice(0, 1);
                    } else if (!assigned && availableSeats.length >= 2) {
                        if (isLuxury && group.length === 2) {
                            // 豪华大巴双人组只能分配到左侧
                            const leftSeats = availableSeats.filter(s => s.seatType === 'left');
                            if (leftSeats.length >= 2) {
                                const seat1 = leftSeats[0];
                                const seat2 = leftSeats[1];
                                assignGroupToSeats(group, seat1, seat2);
                                removeSeatFromAvailable(availableSeats, seat1);
                                removeSeatFromAvailable(availableSeats, seat2);
                                assigned = true;
                            }
                        } else {
                            const seat1 = availableSeats[0];
                            const seat2 = availableSeats[1];
                            assignGroupToSeats(group, seat1, seat2);
                            availableSeats.splice(0, 2);
                        }
                    }
                }
            }
            
            // 查找单人座位
            function findSingleSeat(availableSeats, seatMap, busType) {
                const isLuxury = busType === '2+1';
                
                for (const seat of availableSeats) {
                    // 豪华大巴的右侧座位总是单座
                    if (isLuxury && seat.seatType === 'right') {
                        return seat;
                    }
                    
                    // 获取同排同侧的相邻座位
                    const adjacentSeats = seatMap.filter(s => 
                        s.row === seat.row && 
                        s.seatType === seat.seatType && 
                        s.seatNumber !== seat.seatNumber
                    );
                    
                    // 检查相邻座位是否都被预留或占用
                    const allAdjacentReserved = adjacentSeats.every(s => s.reserved || s.occupied);
                    
                    if (adjacentSeats.length > 0 && allAdjacentReserved) {
                        return seat;
                    }
                }
                
                return null;
            }
            
            // 分配单人座位
            function assignSingleToSeat(passenger, seat) {
                const groupId = Math.floor(Math.random() * 1000000);
                seat.occupied = true;
                seat.passenger = passenger;
                seat.groupId = groupId;
                seat.singleOccupancy = true;
                seat.singleOccupied = true;
            }
            
            // 分配组座位
            function assignGroupToSeats(group, seat1, seat2) {
                const groupId = Math.floor(Math.random() * 1000000);
                
                if (group.length === 1) {
                    // 单人组分配两个座位
                    seat1.occupied = true;
                    seat1.passenger = group[0];
                    seat1.groupId = groupId;
                    seat1.singleOccupancy = true;
                    
                    seat2.occupied = true;
                    seat2.passenger = null;
                    seat2.groupId = groupId;
                    seat2.singleOccupancy = true;
                } else {
                    // 双人组
                    seat1.occupied = true;
                    seat1.passenger = group[0];
                    seat1.groupId = groupId;
                    
                    seat2.occupied = true;
                    seat2.passenger = group[1];
                    seat2.groupId = groupId;
                }
            }
            
            // 从可用座位中移除
            function removeSeatFromAvailable(availableSeats, seat) {
                const index = availableSeats.findIndex(s => s.seatNumber === seat.seatNumber);
                if (index !== -1) availableSeats.splice(index, 1);
            }
            
            // 显示座位布局
            function displaySeatLayout(seatMap, totalSeats, busType) {
                const isLuxury = busType === '2+1';
                
                // 按行分组座位
                const rows = {};
                seatMap.forEach(seat => {
                    if (!rows[seat.row]) rows[seat.row] = [];
                    rows[seat.row].push(seat);
                });
                
                // 生成HTML
                let html = '<div class="bus">';
                html += '<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div><div class="loading-text">正在分配座位...</div></div>';
                
                // 司机行
                html += `
                    <div class="driver-seat">
                        <i class="fas fa-user-shield"></i> 司机
                    </div>
                `;
                
                // 乘客行
                const passengerRows = Object.keys(rows)
                    .filter(key => key != 0)
                    .sort((a, b) => parseInt(a) - parseInt(b));
                
                html += '<div class="seat-rows">';
                for (const rowKey of passengerRows) {
                    const rowSeats = rows[rowKey];
                    
                    // 左侧座位
                    const leftSeats = rowSeats.filter(seat => seat.col < (isLuxury ? 2 : 2)).sort((a, b) => a.col - b.col);
                    // 右侧座位
                    const rightSeats = rowSeats.filter(seat => seat.col >= (isLuxury ? 2 : 2)).sort((a, b) => a.col - b.col);
                    
                    // 获取中文大写行号
                    const rowNumber = getChineseNumber(parseInt(rowKey));
                    
                    html += `<div class="seat-row">`;
                    html += `<div class="row-number">${rowNumber}</div>`;
                    
                    // 左侧座位组
                    html += '<div class="left-seats">';
                    for (const seat of leftSeats) {
                        html += renderSeat(seat);
                    }
                    html += '</div>';
                    
                    // 过道
                    html += '<div class="aisle"></div>';
                    
                    // 右侧座位组
                    html += '<div class="right-seats">';
                    for (const seat of rightSeats) {
                        html += renderSeat(seat);
                    }
                    html += '</div>';
                    
                    html += '</div>';
                }
                html += '</div></div>';
                
                const busContainer = document.createElement('div');
                busContainer.className = 'bus-container';
                busContainer.innerHTML = html;
                seatLayout.innerHTML = '';
                seatLayout.appendChild(busContainer);
            }
            
            // 渲染单个座位
            function renderSeat(seat) {
                let seatClass = 'seat';
                if (seat.type === 'driver') seatClass += ' reserved';
                else if (seat.reserved) seatClass += ' reserved';
                else if (seat.occupied) {
                    if (seat.singleOccupied) seatClass += ' single-occupied';
                    else if (seat.singleOccupancy) seatClass += ' single';
                    else seatClass += ' occupied';
                }
                
                // 添加动画延迟
                const animationDelay = (seat.row * 0.1) + (seat.col * 0.05) + 's';
                
                return `
                    <div class="${seatClass}" style="animation-delay: ${animationDelay}">
                        <div class="seat-number">${seat.seatNumber}</div>
                        ${seat.passenger ? `<div class="passenger-name">${seat.passenger}</div>` : ''}
                    </div>
                `;
            }
            
            // 获取中文大写数字
            function getChineseNumber(num) {
                return num <= 10 ? chineseNumbers[num] : num;
            }
            
            // 显示乘客结果
            function displayPassengerResults(seatMap, groups) {
                // 收集分配结果
                const occupiedSeats = seatMap.filter(seat => 
                    seat.occupied && seat.passenger && seat.type !== 'driver'
                );
                
                // 按组ID分组
                const groupsMap = {};
                occupiedSeats.forEach(seat => {
                    if (!groupsMap[seat.groupId]) groupsMap[seat.groupId] = [];
                    groupsMap[seat.groupId].push(seat);
                });
                
                // 生成HTML
                let html = '<div class="passenger-list">';
                
                for (const groupId in groupsMap) {
                    const seats = groupsMap[groupId];
                    const isSingle = seats.length === 1;
                    const isSingleOccupied = seats.length === 1 && seats[0].singleOccupied;
                    
                    let itemClass = 'passenger-item';
                    if (isSingle) {
                        itemClass += isSingleOccupied ? ' single-occupied' : ' single';
                    } else {
                        itemClass += ' group';
                    }
                    
                    html += `
                        <div class="${itemClass}">
                            <div class="group-header">
                                ${isSingle ? 
                                    (isSingleOccupied ? 
                                        '<i class="fas fa-user-clock"></i> 单人占单座' : 
                                        '<i class="fas fa-user"></i> 单人乘客') : 
                                    '<i class="fas fa-user-friends"></i> 同行乘客'}
                            </div>
                    `;
                    
                    for (const seat of seats) {
                        html += `
                            <div class="passenger">
                                <i class="fas fa-user"></i> ${seat.passenger} - 座位 ${seat.seatNumber}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                // 添加未分配乘客
                const unassigned = groups.flat().filter(passenger => 
                    !occupiedSeats.some(seat => seat.passenger === passenger)
                );
                
                if (unassigned.length > 0) {
                    html += `
                        <div class="passenger-item" style="grid-column: 1 / -1; background: linear-gradient(135deg, #ffebee, #ffcdd2);">
                            <div class="group-header"><i class="fas fa-exclamation-triangle"></i> 未分配乘客</div>
                    `;
                    
                    for (const passenger of unassigned) {
                        html += `<div class="passenger"><i class="fas fa-user"></i> ${passenger}</div>`;
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
                passengerResults.innerHTML = html;
            }
            
            // 更新系统状态
            function updateSystemStatus(text, isReady) {
                systemStatus.textContent = text;
                systemStatus.previousElementSibling.className = 
                    `status-indicator ${isReady ? 'status-ready' : 'status-waiting'}`;
            }
            
            // 更新座位使用率
            function updateSeatUsage(seatMap, passengerSeats) {
                const occupiedSeats = seatMap.filter(seat => seat.occupied && seat.type !== 'driver').length;
                const usagePercentage = Math.round((occupiedSeats / passengerSeats) * 100);
                seatUsage.textContent = `${usagePercentage}%`;
                progressBar.style.width = `${usagePercentage}%`;
            }
            
            // 重置系统
            function resetSystem() {
                document.getElementById('totalSeats').value = '22';
                document.getElementById('reservedSeats').value = '1 2 3 4';
                document.getElementById('passengerData').value = '张三+李四\n王五\n赵六+钱七\n孙八\n周九+吴十\n郑十一\n钱十二+孙十三\n林十四\n杨十五\n陈十六';
                seatLayout.innerHTML = '<div class="bus-container"><div class="bus"><div class="driver-seat"><i class="fas fa-user-shield"></i> 司机</div><div class="empty-row">请设置参数并点击"开始抽签分配"按钮生成座位布局</div></div></div>';
                passengerResults.innerHTML = '<div class="empty-row">座位分配结果将显示在这里</div>';
                updateSeatUsage([], 0);
                updateSystemStatus("准备就绪", true);
                
                // 重置车型选择
                busTypeOptions.forEach(opt => opt.classList.remove('active'));
                busTypeOptions[0].classList.add('active');
                busTypeInput.value = '2+2';
            }
            
            // 重置系统状态
            function resetSystemStatus() {
                updateSystemStatus("准备就绪", true);
                loadingOverlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>